"use strict";
///<reference types="./Libraries/FudgeCore.js"/>
///<reference types="./Libraries/cannon.min.js"/>
var FudgePhysics_Communication;
///<reference types="./Libraries/FudgeCore.js"/>
///<reference types="./Libraries/cannon.min.js"/>
(function (FudgePhysics_Communication) {
    var f = FudgeCore;
    window.addEventListener("load", init);
    const app = document.querySelector("canvas");
    let viewPort;
    let hierarchy;
    let fps;
    const times = [];
    let cubes = new Array();
    let fpsDisplay = document.querySelector("h2#FPS");
    let bodies = new Array();
    let world = new CANNON.World();
    function init(_event) {
        f.Debug.log(app);
        f.RenderManager.initialize();
        hierarchy = new f.Node("Scene");
        let ground = createCompleteMeshNode("Ground", new f.Material("Ground", f.ShaderFlat, new f.CoatColored(new f.Color(0.2, 0.2, 0.2, 1))), new f.MeshCube());
        let cmpGroundMesh = ground.getComponent(f.ComponentTransform);
        cmpGroundMesh.local.scale(new f.Vector3(10, 0.3, 10));
        hierarchy.appendChild(ground);
        cubes[0] = createCompleteMeshNode("Cube_1", new f.Material("Cube", f.ShaderFlat, new f.CoatColored(new f.Color(1, 0, 0, 1))), new f.MeshCube());
        let cmpCubeTransform = cubes[0].getComponent(f.ComponentTransform);
        cmpCubeTransform.local.translate(new f.Vector3(0, 2, 0));
        cmpCubeTransform.local.rotateX(45);
        let cmpCubeMesh = cubes[0].getComponent(f.ComponentMesh);
        hierarchy.appendChild(cubes[0]);
        cubes[1] = createCompleteMeshNode("Cube_2", new f.Material("Cube", f.ShaderFlat, new f.CoatColored(new f.Color(1, 0, 0, 1))), new f.MeshCube());
        let cmpCubeTransform2 = cubes[1].getComponent(f.ComponentTransform);
        cmpCubeTransform2.local.translate(new f.Vector3(0, 3.5, 0.4));
        hierarchy.appendChild(cubes[1]);
        let cmpLight = new f.ComponentLight(new f.LightDirectional(f.Color.CSS("WHITE")));
        cmpLight.pivot.lookAt(new f.Vector3(0.5, -1, -0.8));
        hierarchy.addComponent(cmpLight);
        let cmpCamera = new f.ComponentCamera();
        cmpCamera.backgroundColor = f.Color.CSS("GREY");
        cmpCamera.pivot.translate(new f.Vector3(2, 2, 10));
        cmpCamera.pivot.lookAt(f.Vector3.ZERO());
        //Physics CANNON
        world.gravity = new CANNON.Vec3(0, -9.81, 0);
        initializePhysicsBody(ground.getComponent(f.ComponentTransform), 0, 0);
        initializePhysicsBody(cmpCubeTransform, 1, 1);
        initializePhysicsBody(cmpCubeTransform2, 1, 2);
        //EndPhysics
        viewPort = new f.Viewport();
        viewPort.initialize("Viewport", hierarchy, cmpCamera, app);
        viewPort.showSceneGraph();
        f.Loop.addEventListener("loopFrame" /* LOOP_FRAME */, update);
        f.Loop.start();
    }
    function update() {
        //Physics CANNON
        world.step(f.Loop.timeFrameGame / 1000);
        applyPhysicsBody(cubes[0].getComponent(f.ComponentTransform), 1);
        // applyPhysicsBody(cubes[1].getComponent(f.ComponentTransform), 2);
        //EndPhysics
        viewPort.draw();
        measureFPS();
    }
    function measureFPS() {
        window.requestAnimationFrame(() => {
            const now = performance.now();
            while (times.length > 0 && times[0] <= now - 1000) {
                times.shift();
            }
            times.push(now);
            fps = times.length;
            fpsDisplay.textContent = "FPS: " + fps.toString();
        });
    }
    function createCompleteMeshNode(_name, _material, _mesh) {
        let node = new f.Node(_name);
        let cmpMesh = new f.ComponentMesh(_mesh);
        let cmpMaterial = new f.ComponentMaterial(_material);
        let cmpTransform = new f.ComponentTransform();
        node.addComponent(cmpMesh);
        node.addComponent(cmpMaterial);
        node.addComponent(cmpTransform);
        return node;
    }
    function initializePhysicsBody(_cmpTransform, massVal, no) {
        let scale = new CANNON.Vec3(_cmpTransform.local.scaling.x / 1.5, _cmpTransform.local.scaling.y / 1.5, _cmpTransform.local.scaling.z / 1.5);
        let pos = new CANNON.Vec3(_cmpTransform.local.translation.x, _cmpTransform.local.translation.y, _cmpTransform.local.translation.z);
        let rotation = new CANNON.Quaternion();
        rotation.setFromEuler(_cmpTransform.local.rotation.x, _cmpTransform.local.rotation.y, _cmpTransform.local.rotation.z);
        bodies[no] = new CANNON.Body({
            mass: massVal,
            position: pos,
            shape: new CANNON.Box(scale)
        });
        world.addBody(bodies[no]);
    }
    function applyPhysicsBody(_cmpTransform, no) {
        let tmpPosition = new f.Vector3(bodies[no].position.x, bodies[no].position.y, bodies[no].position.z);
        let tmpRotation; // =  makeRotationFromQuaternion(bodies[no].quaternion); //, new f.Vector3(0, 0, 1)); //f.Vector3.ONE(1)); //_cmpTransform.local.rotation);
        tmpRotation = transformVectorByQuaternion(_cmpTransform.local.rotation, bodies[no].quaternion);
        f.Debug.log(tmpRotation);
        let tmpMatrix = f.Matrix4x4.TRANSLATION(tmpPosition);
        let tmpRotMatrix = new f.Matrix4x4();
        // f.Debug.log(tmpRotation.x);
        tmpRotMatrix.rotateY(tmpRotation.y);
        tmpRotMatrix.rotateX(tmpRotation.x);
        tmpRotMatrix.rotateZ(tmpRotation.z);
        // f.Debug.log(tmpRotMatrix);
        tmpMatrix.multiply(tmpRotMatrix);
        _cmpTransform.local.set(tmpMatrix);
        //_cmpTransform.local.rotate(tmpRotation);
        //f.Debug.log(_cmpTransform.local.rotation);
        let cmpMesh = _cmpTransform.getContainer().getComponent(f.ComponentMesh);
        //cmpMesh.pivot.rotate(tmpRotation);
        //f.Debug.log(cmpMesh.pivot.rotation);
    }
    function makeRotationFromQuaternion(q, targetAxis = new f.Vector3(1, 1, 1)) {
        let angles = new f.Vector3();
        // roll (x-axis rotation)
        let sinr_cosp = 2 * (q.w * q.x + q.y * q.z);
        let cosr_cosp = 1 - 2 * (q.x * q.x + q.y * q.y);
        angles.x = Math.atan2(sinr_cosp, cosr_cosp);
        // pitch (y-axis rotation)
        let sinp = 2 * (q.w * q.y - q.z * q.x);
        if (Math.abs(sinp) >= 1)
            angles.y = copysign(Math.PI / 2, sinp); // use 90 degrees if out of range
        else
            angles.y = Math.asin(sinp);
        // yaw (z-axis rotation)
        let siny_cosp = 2 * (q.w * q.z + q.x * q.y);
        let cosy_cosp = 1 - 2 * (q.y * q.y + q.z * q.z);
        angles.z = Math.atan2(siny_cosp, cosy_cosp);
        //f.Debug.log(angles);
        return angles;
    }
    function transformVectorByQuaternion(value, rotation) {
        let angles;
        let x2 = rotation.x + rotation.x;
        let y2 = rotation.y + rotation.y;
        let z2 = rotation.z + rotation.z;
        let wx2 = rotation.w * x2;
        let wy2 = rotation.w * y2;
        let wz2 = rotation.w * z2;
        let xx2 = rotation.x * x2;
        let xy2 = rotation.x * y2;
        let xz2 = rotation.x * z2;
        let yy2 = rotation.y * y2;
        let yz2 = rotation.y * z2;
        let zz2 = rotation.z * z2;
        angles = new f.Vector3(value.x * (1.0 - yy2 - zz2) + value.y * (xy2 - wz2) + value.z * (xz2 + wy2), value.x * (xy2 + wz2) + value.y * (1.0 - xx2 - zz2) + value.z * (yz2 - wx2), value.x * (xz2 - wy2) + value.y * (yz2 + wx2) + value.z * (1.0 - xx2 - yy2));
        //f.Debug.log(angles);
        return angles;
    }
    function copysign(a, b) {
        return b < 0 ? -Math.abs(a) : Math.abs(a);
    }
    function Vec3ToQuaternion(rotation) {
        //  Roll first, about axis the object is facing, then
        //  pitch upward, then yaw to face into the new heading
        let yaw = rotation.y;
        let pitch = rotation.x;
        let roll = rotation.z;
        let sr, cr, sp, cp, sy, cy;
        let halfRoll = roll * 0.5;
        sr = Math.sin(halfRoll);
        cr = Math.cos(halfRoll);
        let halfPitch = pitch * 0.5;
        sp = Math.sin(halfPitch);
        cp = Math.cos(halfPitch);
        let halfYaw = yaw * 0.5;
        sy = Math.sin(halfYaw);
        cy = Math.cos(halfYaw);
        let result;
        result.X = cy * sp * cr + sy * cp * sr;
        result.Y = sy * cp * cr - cy * sp * sr;
        result.Z = cy * cp * sr - sy * sp * cr;
        result.W = cy * cp * cr + sy * sp * sr;
        return result;
    }
})(FudgePhysics_Communication || (FudgePhysics_Communication = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIk1haW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLGdEQUFnRDtBQUNoRCxpREFBaUQ7QUFFakQsSUFBVSwwQkFBMEIsQ0FvT25DO0FBdk9ELGdEQUFnRDtBQUNoRCxpREFBaUQ7QUFFakQsV0FBVSwwQkFBMEI7SUFDaEMsSUFBTyxDQUFDLEdBQUcsU0FBUyxDQUFDO0lBR3JCLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDdEMsTUFBTSxHQUFHLEdBQXNCLFFBQVEsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDaEUsSUFBSSxRQUFvQixDQUFDO0lBQ3pCLElBQUksU0FBaUIsQ0FBQztJQUN0QixJQUFJLEdBQVcsQ0FBQztJQUNoQixNQUFNLEtBQUssR0FBYSxFQUFFLENBQUM7SUFDM0IsSUFBSSxLQUFLLEdBQWEsSUFBSSxLQUFLLEVBQUUsQ0FBQztJQUNsQyxJQUFJLFVBQVUsR0FBZ0IsUUFBUSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUMvRCxJQUFJLE1BQU0sR0FBRyxJQUFJLEtBQUssRUFBRSxDQUFDO0lBRXpCLElBQUksS0FBSyxHQUFHLElBQUksTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBRS9CLFNBQVMsSUFBSSxDQUFDLE1BQWE7UUFDekIsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDakIsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUM3QixTQUFTLEdBQUcsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRWhDLElBQUksTUFBTSxHQUFXLHNCQUFzQixDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUMs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QUcsRUFBRSxDQUFDO1FBQ2xDLElBQUksR0FBRyxHQUFXLFFBQVEsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ2xDLElBQUksR0FBRyxHQUFXLFFBQVEsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ2xDLElBQUksR0FBRyxHQUFXLFFBQVEsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ2xDLElBQUksR0FBRyxHQUFXLFFBQVEsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBRWxDLE1BQU0sR0FBRyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQ2QsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxFQUMzRSxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLEVBQzNFLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ3JGLHNCQUFzQjtRQUN0QixPQUFPLE1BQU0sQ0FBQztJQUNaLENBQUM7SUFHTCxTQUFTLFFBQVEsQ0FBQyxDQUFTLEVBQUUsQ0FBUztRQUN0QyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBRUMsU0FBUyxnQkFBZ0IsQ0FBQyxRQUFtQjtRQUNyQyxxREFBcUQ7UUFDckQsdURBQXVEO1FBRXZELElBQUksR0FBRyxHQUFXLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDN0IsSUFBSSxLQUFLLEdBQVcsUUFBUSxDQUFDLENBQUMsQ0FBQztRQUMvQixJQUFJLElBQUksR0FBVyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBQzlCLElBQUksRUFBVSxFQUFFLEVBQVUsRUFBRSxFQUFVLEVBQUUsRUFBVSxFQUFFLEVBQVUsRUFBRSxFQUFVLENBQUM7UUFFM0UsSUFBSSxRQUFRLEdBQVcsSUFBSSxHQUFHLEdBQUcsQ0FBQztRQUNsQyxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN4QixFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUV4QixJQUFJLFNBQVMsR0FBVyxLQUFLLEdBQUcsR0FBRyxDQUFDO1FBQ3BDLEVBQUUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3pCLEVBQUUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRXpCLElBQUksT0FBTyxHQUFHLEdBQUcsR0FBRyxHQUFHLENBQUM7UUFDeEIsRUFBRSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDdkIsRUFBRSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFdkIsSUFBSSxNQUFXLENBQUM7UUFFaEIsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQztRQUN2QyxNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDO1FBQ3ZDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUM7UUFDdkMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQztRQUV2QyxPQUFPLE1BQU0sQ0FBQztJQUNsQixDQUFDO0FBRVQsQ0FBQyxFQXBPUywwQkFBMEIsS0FBMUIsMEJBQTBCLFFBb09uQyIsInNvdXJjZXNDb250ZW50IjpbIi8vLzxyZWZlcmVuY2UgdHlwZXM9XCIuL0xpYnJhcmllcy9GdWRnZUNvcmUuanNcIi8+XHJcbi8vLzxyZWZlcmVuY2UgdHlwZXM9XCIuL0xpYnJhcmllcy9jYW5ub24ubWluLmpzXCIvPlxyXG5cclxubmFtZXNwYWNlIEZ1ZGdlUGh5c2ljc19Db21tdW5pY2F0aW9uIHtcclxuICAgIGltcG9ydCBmID0gRnVkZ2VDb3JlO1xyXG5cclxuICAgIFxyXG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoXCJsb2FkXCIsIGluaXQpO1xyXG4gICAgY29uc3QgYXBwOiBIVE1MQ2FudmFzRWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCJjYW52YXNcIik7XHJcbiAgICBsZXQgdmlld1BvcnQ6IGYuVmlld3BvcnQ7XHJcbiAgICBsZXQgaGllcmFyY2h5OiBmLk5vZGU7XHJcbiAgICBsZXQgZnBzOiBudW1iZXI7XHJcbiAgICBjb25zdCB0aW1lczogbnVtYmVyW10gPSBbXTtcclxuICAgIGxldCBjdWJlczogZi5Ob2RlW10gPSBuZXcgQXJyYXkoKTtcclxuICAgIGxldCBmcHNEaXNwbGF5OiBIVE1MRWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCJoMiNGUFNcIik7XHJcbiAgICBsZXQgYm9kaWVzID0gbmV3IEFycmF5KCk7XHJcblxyXG4gICAgbGV0IHdvcmxkID0gbmV3IENBTk5PTi5Xb3JsZCgpO1xyXG5cclxuICAgIGZ1bmN0aW9uIGluaXQoX2V2ZW50OiBFdmVudCk6IHZvaWQge1xyXG4gICAgICBmLkRlYnVnLmxvZyhhcHApO1xyXG4gICAgICBmLlJlbmRlck1hbmFnZXIuaW5pdGlhbGl6ZSgpO1xyXG4gICAgICBoaWVyYXJjaHkgPSBuZXcgZi5Ob2RlKFwiU2NlbmVcIik7XHJcbiAgICAgXHJcbiAgICAgIGxldCBncm91bmQ6IGYuTm9kZSA9IGNyZWF0ZUNvbXBsZXRlTWVzaE5vZGUoXCJHcm91bmRcIiwgbmV3IGYuTWF0ZXJpYWwoXCJHcm91bmRcIiwgZi5TaGFkZXJGbGF0LCBuZXcgZi5Db2F0Q29sb3JlZChuZXcgZi5Db2xvcigwLjIsIDAuMiAsIDAuMiwgMSkpKSwgbmV3IGYuTWVzaEN1YmUoKSk7XHJcbiAgICAgIGxldCBjbXBHcm91bmRNZXNoOiBmLkNvbXBvbmVudFRyYW5zZm9ybSA9IGdyb3VuZC5nZXRDb21wb25lbnQoZi5Db21wb25lbnRUcmFuc2Zvcm0pO1xyXG4gIFxyXG4gICAgICBjbXBHcm91bmRNZXNoLmxvY2FsLnNjYWxlKG5ldyBmLlZlY3RvcjMoMTAsIDAuMywgMTApKTtcclxuICAgICAgaGllcmFyY2h5LmFwcGVuZENoaWxkKGdyb3VuZCk7XHJcblxyXG4gICAgICBjdWJlc1swXSA9IGNyZWF0ZUNvbXBsZXRlTWVzaE5vZGUoXCJDdWJlXzFcIiwgbmV3IGYuTWF0ZXJpYWwoXCJDdWJlXCIsIGYuU2hhZGVyRmxhdCwgbmV3IGYuQ29hdENvbG9yZWQobmV3IGYuQ29sb3IoMSwgMCAsIDAsIDEpKSksIG5ldyBmLk1lc2hDdWJlKCkpO1xyXG4gICAgICBsZXQgY21wQ3ViZVRyYW5zZm9ybTogZi5Db21wb25lbnRUcmFuc2Zvcm0gPSBjdWJlc1swXS5nZXRDb21wb25lbnQoZi5Db21wb25lbnRUcmFuc2Zvcm0pO1xyXG4gICAgICBjbXBDdWJlVHJhbnNmb3JtLmxvY2FsLnRyYW5zbGF0ZShuZXcgZi5WZWN0b3IzKDAsIDIsIDApKTtcclxuICAgICAgY21wQ3ViZVRyYW5zZm9ybS5sb2NhbC5yb3RhdGVYKDQ1KTtcclxuICAgICAgbGV0IGNtcEN1YmVNZXNoOiBmLkNvbXBvbmVudE1lc2ggPSBjdWJlc1swXS5nZXRDb21wb25lbnQoZi5Db21wb25lbnRNZXNoKTtcclxuICAgICAgaGllcmFyY2h5LmFwcGVuZENoaWxkKGN1YmVzWzBdKTtcclxuXHJcbiAgICAgIGN1YmVzWzFdID0gY3JlYXRlQ29tcGxldGVNZXNoTm9kZShcIkN1YmVfMlwiLCBuZXcgZi5NYXRlcmlhbChcIkN1YmVcIiwgZi5TaGFkZXJGbGF0LCBuZXcgZi5Db2F0Q29sb3JlZChuZXcgZi5Db2xvcigxLCAwICwgMCwgMSkpKSwgbmV3IGYuTWVzaEN1YmUoKSk7XHJcbiAgICAgIGxldCBjbXBDdWJlVHJhbnNmb3JtMjogZi5Db21wb25lbnRUcmFuc2Zvcm0gPSBjdWJlc1sxXS5nZXRDb21wb25lbnQoZi5Db21wb25lbnRUcmFuc2Zvcm0pO1xyXG4gICAgICBjbXBDdWJlVHJhbnNmb3JtMi5sb2NhbC50cmFuc2xhdGUobmV3IGYuVmVjdG9yMygwLCAzLjUsIDAuNCkpO1xyXG4gICAgICBoaWVyYXJjaHkuYXBwZW5kQ2hpbGQoY3ViZXNbMV0pO1xyXG5cclxuICAgICAgbGV0IGNtcExpZ2h0OiBmLkNvbXBvbmVudExpZ2h0ID0gbmV3IGYuQ29tcG9uZW50TGlnaHQobmV3IGYuTGlnaHREaXJlY3Rpb25hbChmLkNvbG9yLkNTUyhcIldISVRFXCIpKSk7XHJcbiAgICAgIGNtcExpZ2h0LnBpdm90Lmxvb2tBdChuZXcgZi5WZWN0b3IzKDAuNSwgLTEsIC0wLjgpKTtcclxuICAgICAgaGllcmFyY2h5LmFkZENvbXBvbmVudChjbXBMaWdodCk7XHJcblxyXG4gICAgICBsZXQgY21wQ2FtZXJhOiBmLkNvbXBvbmVudENhbWVyYSA9IG5ldyBmLkNvbXBvbmVudENhbWVyYSgpO1xyXG4gICAgICBjbXBDYW1lcmEuYmFja2dyb3VuZENvbG9yID0gZi5Db2xvci5DU1MoXCJHUkVZXCIpO1xyXG4gICAgICBjbXBDYW1lcmEucGl2b3QudHJhbnNsYXRlKG5ldyBmLlZlY3RvcjMoMiwgMiwgMTApKTtcclxuICAgICAgY21wQ2FtZXJhLnBpdm90Lmxvb2tBdChmLlZlY3RvcjMuWkVSTygpKTtcclxuXHJcbiAgICAgIC8vUGh5c2ljcyBDQU5OT05cclxuICAgICAgd29ybGQuZ3Jhdml0eSA9IG5ldyBDQU5OT04uVmVjMygwLCAtOS44MSwgMCk7XHJcbiAgICAgIGluaXRpYWxpemVQaHlzaWNzQm9keShncm91bmQuZ2V0Q29tcG9uZW50KGYuQ29tcG9uZW50VHJhbnNmb3JtKSwgMCwgMCk7XHJcbiAgICAgIGluaXRpYWxpemVQaHlzaWNzQm9keShjbXBDdWJlVHJhbnNmb3JtLCAxLCAxKTtcclxuICAgICAgaW5pdGlhbGl6ZVBoeXNpY3NCb2R5KGNtcEN1YmVUcmFuc2Zvcm0yLCAxLCAyKTtcclxuICAgICAgLy9FbmRQaHlzaWNzXHJcblxyXG4gICAgICB2aWV3UG9ydCA9IG5ldyBmLlZpZXdwb3J0KCk7XHJcbiAgICAgIHZpZXdQb3J0LmluaXRpYWxpemUoXCJWaWV3cG9ydFwiLCBoaWVyYXJjaHksIGNtcENhbWVyYSwgYXBwKTtcclxuXHJcbiAgICAgIHZpZXdQb3J0LnNob3dTY2VuZUdyYXBoKCk7XHJcblxyXG4gICAgICBmLkxvb3AuYWRkRXZlbnRMaXN0ZW5lcihmLkVWRU5ULkxPT1BfRlJBTUUsIHVwZGF0ZSk7XHJcbiAgICAgIGYuTG9vcC5zdGFydCgpO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBmdW5jdGlvbiB1cGRhdGUoKTogdm9pZCB7XHJcbiAgICAgIFxyXG4gICAgICAvL1BoeXNpY3MgQ0FOTk9OXHJcbiAgICAgIHdvcmxkLnN0ZXAoZi5Mb29wLnRpbWVGcmFtZUdhbWUgLyAxMDAwKTtcclxuICAgICAgYXBwbHlQaHlzaWNzQm9keShjdWJlc1swXS5nZXRDb21wb25lbnQoZi5Db21wb25lbnRUcmFuc2Zvcm0pLCAxKTtcclxuICAgICAvLyBhcHBseVBoeXNpY3NCb2R5KGN1YmVzWzFdLmdldENvbXBvbmVudChmLkNvbXBvbmVudFRyYW5zZm9ybSksIDIpO1xyXG4gICAgICAvL0VuZFBoeXNpY3NcclxuXHJcbiAgICAgIHZpZXdQb3J0LmRyYXcoKTtcclxuICAgICAgbWVhc3VyZUZQUygpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIG1lYXN1cmVGUFMoKTogdm9pZCB7XHJcbiAgICAgICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG5vdyA9IHBlcmZvcm1hbmNlLm5vdygpO1xyXG4gICAgICAgICAgICB3aGlsZSAodGltZXMubGVuZ3RoID4gMCAmJiB0aW1lc1swXSA8PSBub3cgLSAxMDAwKSB7XHJcbiAgICAgICAgICAgICAgdGltZXMuc2hpZnQoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aW1lcy5wdXNoKG5vdyk7XHJcbiAgICAgICAgICAgIGZwcyA9IHRpbWVzLmxlbmd0aDtcclxuICAgICAgICAgICAgZnBzRGlzcGxheS50ZXh0Q29udGVudCA9IFwiRlBTOiBcIiArIGZwcy50b1N0cmluZygpOyBcclxuICAgICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGNyZWF0ZUNvbXBsZXRlTWVzaE5vZGUoX25hbWU6IHN0cmluZywgX21hdGVyaWFsOiBmLk1hdGVyaWFsLCBfbWVzaDogZi5NZXNoKTogZi5Ob2RlIHtcclxuICAgICAgbGV0IG5vZGU6IGYuTm9kZSA9IG5ldyBmLk5vZGUoX25hbWUpO1xyXG4gICAgICBsZXQgY21wTWVzaDogZi5Db21wb25lbnRNZXNoID0gbmV3IGYuQ29tcG9uZW50TWVzaChfbWVzaCk7XHJcbiAgICAgIGxldCBjbXBNYXRlcmlhbDogZi5Db21wb25lbnRNYXRlcmlhbCA9IG5ldyBmLkNvbXBvbmVudE1hdGVyaWFsKF9tYXRlcmlhbCk7XHJcbiAgXHJcbiAgICAgIGxldCBjbXBUcmFuc2Zvcm06IGYuQ29tcG9uZW50VHJhbnNmb3JtID0gbmV3IGYuQ29tcG9uZW50VHJhbnNmb3JtKCk7XHJcbiAgICAgIG5vZGUuYWRkQ29tcG9uZW50KGNtcE1lc2gpO1xyXG4gICAgICBub2RlLmFkZENvbXBvbmVudChjbXBNYXRlcmlhbCk7XHJcbiAgICAgIG5vZGUuYWRkQ29tcG9uZW50KGNtcFRyYW5zZm9ybSk7XHJcbiAgXHJcbiAgICAgIHJldHVybiBub2RlO1xyXG4gIH1cclxuXHJcbiAgICBmdW5jdGlvbiBpbml0aWFsaXplUGh5c2ljc0JvZHkoX2NtcFRyYW5zZm9ybTogZi5Db21wb25lbnRUcmFuc2Zvcm0sIG1hc3NWYWw6IG51bWJlciwgbm86IG51bWJlcikge1xyXG4gICAgbGV0IHNjYWxlOiBDQU5OT04uVmVjMyA9IG5ldyBDQU5OT04uVmVjMyhfY21wVHJhbnNmb3JtLmxvY2FsLnNjYWxpbmcueCAvIDEuNSwgX2NtcFRyYW5zZm9ybS5sb2NhbC5zY2FsaW5nLnkgLyAxLjUsIF9jbXBUcmFuc2Zvcm0ubG9jYWwuc2NhbGluZy56IC8gMS41KTtcclxuICAgIGxldCBwb3M6IENBTk5PTi5WZWMzID0gIG5ldyBDQU5OT04uVmVjMyhfY21wVHJhbnNmb3JtLmxvY2FsLnRyYW5zbGF0aW9uLngsIF9jbXBUcmFuc2Zvcm0ubG9jYWwudHJhbnNsYXRpb24ueSwgX2NtcFRyYW5zZm9ybS5sb2NhbC50cmFuc2xhdGlvbi56KTtcclxuICAgIGxldCByb3RhdGlvbjogQ0FOTk9OLlF1YXRlcm5pb24gPSBuZXcgQ0FOTk9OLlF1YXRlcm5pb24oKTtcclxuICAgIHJvdGF0aW9uLnNldEZyb21FdWxlcihfY21wVHJhbnNmb3JtLmxvY2FsLnJvdGF0aW9uLngsIF9jbXBUcmFuc2Zvcm0ubG9jYWwucm90YXRpb24ueSwgX2NtcFRyYW5zZm9ybS5sb2NhbC5yb3RhdGlvbi56KTtcclxuICAgXHJcbiAgICBib2RpZXNbbm9dID0gbmV3IENBTk5PTi5Cb2R5KHtcclxuICAgICAgbWFzczogbWFzc1ZhbCwgLy8ga2dcclxuICAgICAgcG9zaXRpb246IHBvcywgLy8gbVxyXG4gICAgICBzaGFwZTogbmV3IENBTk5PTi5Cb3goc2NhbGUpXHJcbiAgIH0pO1xyXG4gICAgd29ybGQuYWRkQm9keShib2RpZXNbbm9dKTtcclxuICB9XHJcblxyXG5cclxuICAgIGZ1bmN0aW9uIGFwcGx5UGh5c2ljc0JvZHkoX2NtcFRyYW5zZm9ybTogZi5Db21wb25lbnRUcmFuc2Zvcm0sIG5vOiBudW1iZXIpOiB2b2lkIHtcclxuXHJcbiAgICAgIGxldCB0bXBQb3NpdGlvbjogZi5WZWN0b3IzID0gbmV3IGYuVmVjdG9yMyhib2RpZXNbbm9dLnBvc2l0aW9uLngsIGJvZGllc1tub10ucG9zaXRpb24ueSwgYm9kaWVzW25vXS5wb3NpdGlvbi56KTtcclxuICBcclxuICAgICAgbGV0IHRtcFJvdGF0aW9uOiBmLlZlY3RvcjM7IC8vID0gIG1ha2VSb3RhdGlvbkZyb21RdWF0ZXJuaW9uKGJvZGllc1tub10ucXVhdGVybmlvbik7IC8vLCBuZXcgZi5WZWN0b3IzKDAsIDAsIDEpKTsgLy9mLlZlY3RvcjMuT05FKDEpKTsgLy9fY21wVHJhbnNmb3JtLmxvY2FsLnJvdGF0aW9uKTtcclxuICAgICAgdG1wUm90YXRpb24gPSB0cmFuc2Zvcm1WZWN0b3JCeVF1YXRlcm5pb24oX2NtcFRyYW5zZm9ybS5sb2NhbC5yb3RhdGlvbiwgYm9kaWVzW25vXS5xdWF0ZXJuaW9uKTtcclxuICAgICAgZi5EZWJ1Zy5sb2codG1wUm90YXRpb24pO1xyXG5cclxuICAgICAgbGV0IHRtcE1hdHJpeDogZi5NYXRyaXg0eDQgPSBmLk1hdHJpeDR4NC5UUkFOU0xBVElPTih0bXBQb3NpdGlvbik7XHJcbiAgICAgIGxldCB0bXBSb3RNYXRyaXg6IGYuTWF0cml4NHg0ID0gbmV3IGYuTWF0cml4NHg0KCk7XHJcbiAgICAgLy8gZi5EZWJ1Zy5sb2codG1wUm90YXRpb24ueCk7XHJcbiAgICAgIHRtcFJvdE1hdHJpeC5yb3RhdGVZKHRtcFJvdGF0aW9uLnkpO1xyXG4gICAgICB0bXBSb3RNYXRyaXgucm90YXRlWCh0bXBSb3RhdGlvbi54KTtcclxuICAgICAgdG1wUm90TWF0cml4LnJvdGF0ZVoodG1wUm90YXRpb24ueik7XHJcbiAgICAgLy8gZi5EZWJ1Zy5sb2codG1wUm90TWF0cml4KTtcclxuICAgICAgdG1wTWF0cml4Lm11bHRpcGx5KHRtcFJvdE1hdHJpeCk7XHJcblxyXG4gICAgICBfY21wVHJhbnNmb3JtLmxvY2FsLnNldCh0bXBNYXRyaXgpO1xyXG4gICAgICAvL19jbXBUcmFuc2Zvcm0ubG9jYWwucm90YXRlKHRtcFJvdGF0aW9uKTtcclxuICAgICAgLy9mLkRlYnVnLmxvZyhfY21wVHJhbnNmb3JtLmxvY2FsLnJvdGF0aW9uKTtcclxuICAgICAgXHJcbiAgICAgIGxldCBjbXBNZXNoOiBmLkNvbXBvbmVudE1lc2ggPSBfY21wVHJhbnNmb3JtLmdldENvbnRhaW5lcigpLmdldENvbXBvbmVudChmLkNvbXBvbmVudE1lc2gpO1xyXG4gICAgICAvL2NtcE1lc2gucGl2b3Qucm90YXRlKHRtcFJvdGF0aW9uKTtcclxuICAgICAgLy9mLkRlYnVnLmxvZyhjbXBNZXNoLnBpdm90LnJvdGF0aW9uKTtcclxuICAgIH1cclxuXHJcbiAgXHJcbiAgICBmdW5jdGlvbiBtYWtlUm90YXRpb25Gcm9tUXVhdGVybmlvbiggcTogYW55LCB0YXJnZXRBeGlzOiBmLlZlY3RvcjMgPSBuZXcgZi5WZWN0b3IzKDEsIDEsIDEpICk6IGYuVmVjdG9yMyB7XHJcbiAgICAgIGxldCBhbmdsZXM6IGYuVmVjdG9yMyA9IG5ldyBmLlZlY3RvcjMoKTtcclxuXHJcbiAgICAgIC8vIHJvbGwgKHgtYXhpcyByb3RhdGlvbilcclxuICAgICAgbGV0IHNpbnJfY29zcDogbnVtYmVyID0gMiAqIChxLncgKiBxLnggKyBxLnkgKiBxLnopO1xyXG4gICAgICBsZXQgY29zcl9jb3NwOiBudW1iZXIgPSAxIC0gMiAqIChxLnggKiBxLnggKyBxLnkgKiBxLnkpO1xyXG4gICAgICBhbmdsZXMueCA9IE1hdGguYXRhbjIoc2lucl9jb3NwLCBjb3NyX2Nvc3ApO1xyXG4gIFxyXG4gICAgICAvLyBwaXRjaCAoeS1heGlzIHJvdGF0aW9uKVxyXG4gICAgICBsZXQgc2lucDogbnVtYmVyID0gMiAqIChxLncgKiBxLnkgLSBxLnogKiBxLngpO1xyXG4gICAgICBpZiAoTWF0aC5hYnMoc2lucCkgPj0gMSlcclxuICAgICAgICAgIGFuZ2xlcy55ID0gY29weXNpZ24oTWF0aC5QSSAvIDIsIHNpbnApOyAvLyB1c2UgOTAgZGVncmVlcyBpZiBvdXQgb2YgcmFuZ2VcclxuICAgICAgZWxzZVxyXG4gICAgICAgICAgYW5nbGVzLnkgPSBNYXRoLmFzaW4oc2lucCk7XHJcbiAgXHJcbiAgICAgIC8vIHlhdyAoei1heGlzIHJvdGF0aW9uKVxyXG4gICAgICBsZXQgc2lueV9jb3NwOiBudW1iZXIgPSAyICogKHEudyAqIHEueiArIHEueCAqIHEueSk7XHJcbiAgICAgIGxldCBjb3N5X2Nvc3A6IG51bWJlciA9IDEgLSAyICogKHEueSAqIHEueSArIHEueiAqIHEueik7XHJcbiAgICAgIGFuZ2xlcy56ID0gTWF0aC5hdGFuMihzaW55X2Nvc3AsIGNvc3lfY29zcCk7XHJcbiAgICAgIC8vZi5EZWJ1Zy5sb2coYW5nbGVzKTtcclxuICAgICAgcmV0dXJuIGFuZ2xlcztcclxuICB9XHJcblxyXG4gICAgZnVuY3Rpb24gdHJhbnNmb3JtVmVjdG9yQnlRdWF0ZXJuaW9uKHZhbHVlOiBmLlZlY3RvcjMsICByb3RhdGlvbjogYW55KTogZi5WZWN0b3IzIHtcclxuICAgICAgbGV0IGFuZ2xlczogZi5WZWN0b3IzO1xyXG5cclxuICAgICAgbGV0IHgyOiBudW1iZXIgPSByb3RhdGlvbi54ICsgcm90YXRpb24ueDtcclxuICAgICAgbGV0IHkyOiBudW1iZXIgPSByb3RhdGlvbi55ICsgcm90YXRpb24ueTtcclxuICAgICAgbGV0IHoyOiBudW1iZXIgPSByb3RhdGlvbi56ICsgcm90YXRpb24uejtcclxuIFxyXG4gICAgICBsZXQgd3gyOiBudW1iZXIgPSByb3RhdGlvbi53ICogeDI7XHJcbiAgICAgIGxldCB3eTI6IG51bWJlciA9IHJvdGF0aW9uLncgKiB5MjtcclxuICAgICAgbGV0IHd6MjogbnVtYmVyID0gcm90YXRpb24udyAqIHoyO1xyXG4gICAgICBsZXQgeHgyOiBudW1iZXIgPSByb3RhdGlvbi54ICogeDI7XHJcbiAgICAgIGxldCB4eTI6IG51bWJlciA9IHJvdGF0aW9uLnggKiB5MjtcclxuICAgICAgbGV0IHh6MjogbnVtYmVyID0gcm90YXRpb24ueCAqIHoyO1xyXG4gICAgICBsZXQgeXkyOiBudW1iZXIgPSByb3RhdGlvbi55ICogeTI7XHJcbiAgICAgIGxldCB5ejI6IG51bWJlciA9IHJvdGF0aW9uLnkgKiB6MjtcclxuICAgICAgbGV0IHp6MjogbnVtYmVyID0gcm90YXRpb24ueiAqIHoyO1xyXG5cclxuICAgICAgYW5nbGVzID0gbmV3IGYuVmVjdG9yMyhcclxuICAgICAgICAgICAgICB2YWx1ZS54ICogKDEuMCAtIHl5MiAtIHp6MikgKyB2YWx1ZS55ICogKHh5MiAtIHd6MikgKyB2YWx1ZS56ICogKHh6MiArIHd5MiksXHJcbiAgICAgICAgICAgICAgdmFsdWUueCAqICh4eTIgKyB3ejIpICsgdmFsdWUueSAqICgxLjAgLSB4eDIgLSB6ejIpICsgdmFsdWUueiAqICh5ejIgLSB3eDIpLFxyXG4gICAgICAgICAgICAgIHZhbHVlLnggKiAoeHoyIC0gd3kyKSArIHZhbHVlLnkgKiAoeXoyICsgd3gyKSArIHZhbHVlLnogKiAoMS4wIC0geHgyIC0geXkyKSk7XHJcbiAgICAgIC8vZi5EZWJ1Zy5sb2coYW5nbGVzKTtcclxuICAgICAgcmV0dXJuIGFuZ2xlcztcclxuICAgICAgICB9XHJcblxyXG4gXHJcbiAgICBmdW5jdGlvbiBjb3B5c2lnbihhOiBudW1iZXIsIGI6IG51bWJlcik6IG51bWJlciB7XHJcbiAgICByZXR1cm4gYiA8IDAgPyAtTWF0aC5hYnMoYSkgOiBNYXRoLmFicyhhKTtcclxuICB9XHJcblxyXG4gICAgZnVuY3Rpb24gVmVjM1RvUXVhdGVybmlvbihyb3RhdGlvbjogZi5WZWN0b3IzKTogYW55IHtcclxuICAgICAgICAgICAgLy8gIFJvbGwgZmlyc3QsIGFib3V0IGF4aXMgdGhlIG9iamVjdCBpcyBmYWNpbmcsIHRoZW5cclxuICAgICAgICAgICAgLy8gIHBpdGNoIHVwd2FyZCwgdGhlbiB5YXcgdG8gZmFjZSBpbnRvIHRoZSBuZXcgaGVhZGluZ1xyXG5cclxuICAgICAgICAgICAgbGV0IHlhdzogbnVtYmVyID0gcm90YXRpb24ueTtcclxuICAgICAgICAgICAgbGV0IHBpdGNoOiBudW1iZXIgPSByb3RhdGlvbi54O1xyXG4gICAgICAgICAgICBsZXQgcm9sbDogbnVtYmVyID0gcm90YXRpb24uejtcclxuICAgICAgICAgICAgbGV0IHNyOiBudW1iZXIsIGNyOiBudW1iZXIsIHNwOiBudW1iZXIsIGNwOiBudW1iZXIsIHN5OiBudW1iZXIsIGN5OiBudW1iZXI7XHJcbiBcclxuICAgICAgICAgICAgbGV0IGhhbGZSb2xsOiBudW1iZXIgPSByb2xsICogMC41O1xyXG4gICAgICAgICAgICBzciA9IE1hdGguc2luKGhhbGZSb2xsKTtcclxuICAgICAgICAgICAgY3IgPSBNYXRoLmNvcyhoYWxmUm9sbCk7XHJcbiBcclxuICAgICAgICAgICAgbGV0IGhhbGZQaXRjaDogbnVtYmVyID0gcGl0Y2ggKiAwLjU7XHJcbiAgICAgICAgICAgIHNwID0gTWF0aC5zaW4oaGFsZlBpdGNoKTtcclxuICAgICAgICAgICAgY3AgPSBNYXRoLmNvcyhoYWxmUGl0Y2gpO1xyXG4gXHJcbiAgICAgICAgICAgIGxldCBoYWxmWWF3ID0geWF3ICogMC41O1xyXG4gICAgICAgICAgICBzeSA9IE1hdGguc2luKGhhbGZZYXcpO1xyXG4gICAgICAgICAgICBjeSA9IE1hdGguY29zKGhhbGZZYXcpO1xyXG4gXHJcbiAgICAgICAgICAgIGxldCByZXN1bHQ6IGFueTtcclxuIFxyXG4gICAgICAgICAgICByZXN1bHQuWCA9IGN5ICogc3AgKiBjciArIHN5ICogY3AgKiBzcjtcclxuICAgICAgICAgICAgcmVzdWx0LlkgPSBzeSAqIGNwICogY3IgLSBjeSAqIHNwICogc3I7XHJcbiAgICAgICAgICAgIHJlc3VsdC5aID0gY3kgKiBjcCAqIHNyIC0gc3kgKiBzcCAqIGNyO1xyXG4gICAgICAgICAgICByZXN1bHQuVyA9IGN5ICogY3AgKiBjciArIHN5ICogc3AgKiBzcjtcclxuIFxyXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICAgIH1cclxuXHJcbn0iXX0=